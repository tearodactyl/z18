// Copyright (c) 2016 The Zcash developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or https://www.opensource.org/licenses/mit-license.php .

#include "uint256.h"
#include "consensus/params.h"

#include <atomic>
#include <mutex>
#include <string>

struct AtomicCounter {
    std::atomic<uint64_t> value;

    AtomicCounter() : value {0} { }

    void increment(){
        ++value;
    }

    void decrement(){
        --value;
    }

    int get() const {
        return value.load();
    }
};

class AtomicTimer {
private:
    std::mutex mtx;
    uint64_t threads;
    int64_t start_time;
    int64_t total_time;

public:
    AtomicTimer() : threads(0), start_time(0), total_time(0) {}

    /**
     * Starts timing on first call, and counts the number of calls.
     */
    void start();

    /**
     * Counts number of calls, and stops timing after it has been called as
     * many times as start().
     */
    void stop();

    bool running();

    uint64_t threadCount();

    double rate(const AtomicCounter& count);
};

extern AtomicCounter transactionsValidated;
extern AtomicCounter ehSolverRuns;
extern AtomicCounter solutionTargetChecks;
extern AtomicTimer miningTimer;

void TrackMinedBlock(uint256 hash);

void MarkStartTime();
double GetLocalSolPS();
int EstimateNetHeight(const Consensus::Params& params, int currentBlockHeight, int64_t currentBlockTime);

void TriggerRefresh();

void ConnectMetricsScreen();
void ThreadShowMetricsScreen();

/**
 * Rendering options:
 * Logo: img2txt -W 90 -H 20 -f utf8 -d none -g design.png >> design.ansi
 */

const std::string METRICS_ART =
"[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m                                                                            [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m                                                                            [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;32;40m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;1;33;93;43m%[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;34;40m                               [0;1;33;93;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;34;40m                               [0;1;33;93;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;32;40m;;;;;;;;;;;;;;;;;;;;[0;34;40m          [0;32;40m:[0;1;33;93;43mS[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%X[0;1;30;90;43m;[0;34;40m         [0;32;40m8[0;1;33;93;43mS[0;33;5;43;103m%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;1;30;90;43m%[0;32;40m%[0;34;40m        [0;32;40m.[0;1;30;90;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;32;40m.[0;34;40m        [0;32;40mS[0;1;30;90;43m%[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;1;33;93;43m%[0;32;40m@[0;34;40m        [0;32;40m [0;1;30;90;43mt[0;33;5;43;103mS%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;1;30;90;43m%[0;32;40m;[0;34;40m        [0;32;40mt[0;1;30;90;43m%[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%[0;32;40m8;;;;;;;;;;:[0;34;40m          [0;32;40m:;;;;;[0;32;5;40;100mS[0;33;5;43;103m%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%[0;32;40mS[0;34;40m                           [0;30;42m8[0;33;5;43;103m%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%[0;32;40mS[0;34;40m                           [0;30;42m8[0;33;5;43;103m%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%[0;32;40mtttttt;[0;34;40m         [0;32;40m.;ttttttttttt[0;33;5;43;103m%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%[0;1;30;90;43m%[0;32;40mt[0;34;40m        [0;32;40m%[0;1;30;90;43m%[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%S[0;1;30;90;43m;[0;34;40m        [0;32;40m [0;1;30;90;43mt[0;33;5;43;103mS%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%[0;1;33;93;43mt[0;32;40mS[0;34;40m        [0;32;40mt[0;1;30;90;43m%[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;32;40m [0;34;40m        [0;1;30;90;42m8[0;33;5;43;103mX%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%[0;1;33;93;43mS[0;30;42m8[0;34;40m        [0;32;40m;[0;1;30;90;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;32;40m:[0;34;40m        [0;32;40m [0;1;30;90;43m;tttttttttttttttttttt%[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%[0;1;33;93;43m%[0;34;40m                                [0;1;30;90;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%[0;1;33;93;43mt[0;34;40m                                [0;1;30;90;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%[0;1;33;93;43mt[0;34;40m                                [0;1;30;90;43mt[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%[0;1;30;90;43mt[0;32;40m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;1;33;93;43mS[0;33;5;43;103m%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m     [0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0;34;40m     [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m                                                                            [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%[0;1;33;93;43mt[0;34;40m                                                                            [0;1;30;90;43mt[0;33;5;43;103m%[0m\n"
"[0;33;5;43;103m%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%[0m\n";



